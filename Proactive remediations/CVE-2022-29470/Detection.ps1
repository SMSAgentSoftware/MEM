# Intune Detection script for CVE-2022-29470 / Intel-SA-00875

# References:
# https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00875.html
# https://nvd.nist.gov/vuln/detail/CVE-2022-29470
# https://www.tenable.com/plugins/nessus/180052

# Windows 10/11 check
$OSInfo = Get-CimInstance Win32_OperatingSystem -Property Version,OSArchitecture | Select Version,OSArchitecture
$OSVersion = [System.Version]$OSInfo.Version
If ($OSVersion.Major -ne 10 -and $OSVersion.Minor -ne 0)
{
    "Not Windows 10/11"
    Exit 0
}

# OSArchitecture check 
If ($OSInfo.OSArchitecture -ne "64-bit")
{
    "Not 64-bit OS"
    Exit 0
}

# Driver check
$dptfDriverVersions = @()
$dptfDriverFiles = Get-ChildItem C:\Windows\System32\DriverStore\FileRepository -Filter dptf*
If ($dptfDriverFiles)
{
    foreach ($DriverFile in $dptfDriverFiles)
    {
        If ($DriverFile.Name -match "acpi")
        {
            $acpi = Get-Item "$($DriverFile.FullName)\dptf_acpi.sys" -ErrorAction SilentlyContinue
            if ($acpi)
            {
                $dptfDriverVersions += [System.Version]$acpi.VersionInfo.ProductVersion
            }
        }
        If ($DriverFile.Name -match "cpu")
        {
            $cpu = Get-Item "$($DriverFile.FullName)\dptf_cpu.sys" -ErrorAction SilentlyContinue
            if ($cpu)
            {
                $dptfDriverVersions += [System.Version]$cpu.VersionInfo.ProductVersion
            }
        }
    }
}
else 
{
    "Drivers not detected"
    Exit 0
}

# Get lowest and highest driver versions
$LowestDriverVersion = $dptfDriverVersions | Select -Unique | Sort-Object -Descending | Select -Last 1
$HighestDriverVersion = $dptfDriverVersions | Select -Unique | Sort-Object -Descending | Select -First 1

# Determine whether remediation is needed
[System.Version]$ReferenceVersion = "8.7.10400.15482"
If ($LowestDriverVersion -lt $ReferenceVersion)
{
    If ($HighestDriverVersion -ge $ReferenceVersion)
    {
        "($LowestDriverVersion) Patched drivers exist alongside older drivers. Need to remove older drivers."
        Exit 1
    }
    else 
    {
        "($LowestDriverVersion) Driver update needed"
        Exit 1
    }
}
else 
{
    "($LowestDriverVersion) Driver version not vulnerable"    
    Exit 0
}
