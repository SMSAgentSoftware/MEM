# Intune Detection script for CVE-2022-29470 / Intel-SA-00875

# References:
# https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00875.html
# https://nvd.nist.gov/vuln/detail/CVE-2022-29470
# https://www.tenable.com/plugins/nessus/180052

# Windows 10/11 check
$OSInfo = Get-CimInstance Win32_OperatingSystem -Property Version,OSArchitecture | Select Version,OSArchitecture
$OSVersion = [System.Version]$OSInfo.Version
If ($OSVersion.Major -ne 10 -and $OSVersion.Minor -ne 0)
{
    "Not Windows 10/11"
    Exit 0
}

# OSArchitecture check 
If ($OSInfo.OSArchitecture -ne "64-bit")
{
    "Not 64-bit OS"
    Exit 0
}

# Driver check
$DeviceDrivers = Get-CimInstance -ClassName Win32_PnPSignedDriver -Filter "DriverProviderName = 'Intel' AND ClassGuid = '{4D36E97D-E325-11CE-BFC1-08002BE10318}' AND DeviceClass='SYSTEM' AND DeviceName like '%Dynamic Tuning%'" 
If ($DeviceDrivers)
{
    $LowestDriverVersion = $DeviceDrivers | 
        Sort -Property DriverVersion -Descending | 
        Select -Last 1 | 
        Select -ExpandProperty DriverVersion

    [System.Version]$ReferenceVersion = "8.7.10400.15482"
    [System.Version]$InstalledVersion = "$LowestDriverVersion"

    If ($InstalledVersion -lt $ReferenceVersion)
    {
        "Driver update needed"
        Exit 1
    }
    else 
    {
        "Driver version not vulnerable ($InstalledVersion)"    
        Exit 0
    }
}
else 
{
    "Drivers not detected"
    Exit 0
}