# Intune Remediation script for CVE-2022-29470 / Intel-SA-00875

# Download the drivers
# Check here in case the driver version / download URL is updated: https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00875.html
$URL = "https://downloadmirror.intel.com/715476/Dynamic_Tuning_Technology-Win10_Win11-8.7.10801.25109.zip"
$TempLocation = $env:TEMP
$FileName = $URL.Split('/')[-1]
$ProgressPreference = 'SilentlyContinue'
try 
{
    Invoke-WebRequest -Uri $url -OutFile "$TempLocation\$FileName" -UseBasicParsing
}
catch 
{
    throw $_.Exception.Message
}

# Check file was downloaded
If ([System.IO.File]::Exists("$TempLocation\$FileName"))
{
    # Check the file hash
    $SHA1Hash = "403BC22BD7F12F01E4C0243EA24E762CD689D41C"
    $FileHash = Get-FileHash -Path "$TempLocation\$FileName" -Algorithm SHA1
    If ($FileHash.Hash -ne $SHA1Hash)
    {
        throw "File hash mismatch" 
    }

    # Expand the file
    $ExpandFolder = $FileName.TrimEnd('.zip')
    try 
    {
       Expand-Archive -Path "$TempLocation\$FileName" -DestinationPath "$TempLocation\$ExpandFolder" -Force -ErrorAction Stop 
    }
    catch 
    {
        throw "Failed to expand archive: $_"
    }

    # Get the current drivers (we'll remove them later) 
    $DeviceDrivers = Get-CimInstance -ClassName Win32_PnPSignedDriver -Filter "DriverProviderName = 'Intel' AND ClassGuid = '{4D36E97D-E325-11CE-BFC1-08002BE10318}' AND DeviceClass='SYSTEM' AND DeviceName like '%Dynamic Tuning%'"

    # Install the new drivers
    $DriverPath = "$TempLocation\$FileName\drivers\x64"
    $Result = pnputil.exe /add-driver $DriverPath\*.inf /install
    $Result | Out-File -FilePath $TempLocation\IntelDTTDriverInstall.txt -Force -ErrorAction SilentlyContinue

    # Remove the older drivers
    $InfFilesToRemove = $DeviceDrivers | Select -ExpandProperty InfName | Select -Unique
    foreach ($InfFile in $InfFilesToRemove)
    {
        $Result = pnputil.exe /delete-driver $InfFile /force
        $Result | Out-File -FilePath "$TempLocation\$InfFile`_Removal.txt" -Force -ErrorAction SilentlyContinue
    }

    # Clean up temp files
    Remove-Item "$TempLocation\$FileName" -Force -ErrorAction SilentlyContinue
    Remove-Item "$TempLocation\$ExpandFolder" -Recurse -Force -ErrorAction SilentlyContinue
}
else 
{
    throw "Download file not found"
}